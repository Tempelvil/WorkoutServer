<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Workout Server</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: sans-serif;
            margin: 30px;
            background: #f5f5f5;
        }

        h1 {
            margin-bottom: 20px;
        }

        .tab-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

            .tab-bar button {
                flex: 1;
                padding: 10px 0;
                font-size: 16px;
                border: none;
                background: #ddd;
                cursor: pointer;
                border-radius: 6px;
            }

                .tab-bar button.active {
                    background: #4caf50;
                    color: #fff;
                }

        /* table */
        .panel {
            background: #fff;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
            max-height: 280px;
            overflow-y: auto;
        }

            .panel.hidden {
                display: none;
            }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

            .panel-header h2 {
                margin: 0;
                font-size: 18px;
            }

            .panel-header button {
                padding: 6px 10px;
                font-size: 14px;
                border-radius: 4px;
                border: none;
                background: #2196f3;
                color: #fff;
                cursor: pointer;
            }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th, td {
            border-bottom: 1px solid #eee;
            padding: 6px 4px;
            text-align: left;
        }

        th {
            background: #fafafa;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        /*Knopki*/
        .action-btn {
            padding: 4px 8px;
            font-size: 13px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }

        .action-view {
            background: #ff9800;
            color: #fff;
        }

        .action-delete {
            background: #f44336;
            color: #fff;
        }

        .add-row button {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px dashed #999;
            background: #fafafa;
            cursor: pointer;
            font-weight: 500;
        }

        #workoutSetsDetails {
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px solid #ddd;
            font-size: 13px;
        }

            #workoutSetsDetails h3 {
                margin: 0 0 6px 0;
                font-size: 15px;
            }

        /* AddSet enter panel Sets */
        .box {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 6px;
            margin-top: 8px;

        }

        .row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 6px 0;
        }

        label {
            width: 120px;
            font-size: 13px;

        }

        input, select {
            padding: 4px 6px;
            font: inherit;
        }

        .small-btn {
            padding: 4px 8px;
            font-size: 13px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            background: #4caf50;
            color: #fff;
        }

            .small-btn.cancel {
                background: #9e9e9e;
            }

        /* LOGS */
        #logBox {
            margin-top: 20px;
            background: #fff;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
        }

            #logBox h3 {
                margin-top: 0;
            }

        pre {
            background: #f0f0f0;
            padding: 8px;
            white-space: pre-wrap;
            margin: 0;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>Workout Server</h1>

    <!-- Main Buttons -->
    <div class="tab-bar">
        <button id="btnWorkouts" onclick="togglePanel('workouts')">Workouts</button>
        <button id="btnExercises" onclick="togglePanel('exercises')">Exercises</button>
        <button id="btnSets" onclick="togglePanel('sets')">Sets</button>
    </div>

    <!--Workouts Panel-->
    <div id="panel-workouts" class="panel hidden">
        <div class="panel-header">
            <h2>Workouts</h2>
        </div>

        <table>
            <thead>
                <tr>
                    <th style="width: 50px;">ID</th>
                    <th>Name</th>
                    <th>Date</th>
                    <th style="width: 90px;">Actions</th>
                </tr>
            </thead>
            <tbody id="tbodyWorkouts">
            </tbody>
            <tfoot>
                <tr class="add-row">
                    <td colspan="4">
                        <button onclick="addWorkout()">+ Add Workout</button>
                    </td>
                </tr>
            </tfoot>
        </table>

        <div id="workoutSetsDetails"></div>
    </div>

    <!--Exercises Panel-->
    <div id="panel-exercises" class="panel hidden">
        <div class="panel-header">
            <h2>Exercises</h2>
            
        </div>

        <table>
            <thead>
                <tr>
                    <th style="width: 50px;">ID</th>
                    <th>Name</th>
                    <th style="width: 90px;">Actions</th>
                </tr>
            </thead>
            <tbody id="tbodyExercises">
            </tbody>
            <tfoot>
                <tr class="add-row">
                    <td colspan="3">
                        <button onclick="addExercise()">+ Add Exercise</button>
                    </td>
                </tr>
            </tfoot>
        </table>
    </div>

    <!--SETS Panel-->>
    <div id="panel-sets" class="panel hidden"> 
        <div class="panel-header">
            <h2>Sets</h2>
        </div>

        <table>
            <thead>
                <tr>
                    <th style="width: 40px;">ID</th>
                    <th style="width: 60px;">Workout</th>
                    <th>Exercise</th>
                    <th>Reps × Aprox</th>
                    <th style="width: 70px;">Weight</th>
                    <th style="width: 80px;">Actions</th>
                </tr>
            </thead>
            <tbody id="tbodySets">
            </tbody>
            <tfoot>
                <tr class="add-row">
                    <td colspan="6">
                        <button onclick="openAddSet()">+ Add Set</button>
                    </td>
                </tr>
            </tfoot>
        </table>

        <!--Add SETS-->
        <div id="addSetBox" class="box hidden">
            <h3>Add Set</h3>

            <div class="row">
                <label for="selWorkout">Workout:</label>
                <select id="selWorkout"></select>
            </div>

            <div class="row">
                <label for="selExercise">Exercise:</label>
                <select id="selExercise"></select>
            </div>

            <div class="row">
                <label for="sWeight">Weight (kg):</label>
                <input id="sWeight" type="number" step="0.1" placeholder="60.0">
            </div>

            <div class="row">
                <label for="sReps">Repetitions:</label>
                <input id="sReps" type="number" placeholder="10">
            </div>

            <div class="row">
                <label for="sAproaches">Aproaches:</label>
                <input id="sAproaches" type="number" placeholder="3">
            </div>

            <div class="row">
                <button class="small-btn" onclick="submitSet()">Submit Set</button>
                <button class="small-btn cancel" onclick="closeAddSet()">Cancel</button>
            </div>
        </div>
    </div>

    <!--LOSG-->
    <div id="logBox">
        <h3>Log / Raw responses:</h3>
        <pre id="output"></pre>
    </div>

    <script>        
        const out = document.getElementById("output");

        function log(data) {
            out.textContent =(typeof data === "string")? data: JSON.stringify(data, null, 2);
        }

        async function getJSON(url) {
            const r = await fetch(url);
            const txt = await r.text();
            try {
                return JSON.parse(txt);
            } catch {
                log({ raw: txt, status: r.status });
                throw new Error("Not JSON: " + r.status + " " + r.statusText);
            }
        }

        async function postJSON(url, body) {
            const r = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body)
            });
            const txt = await r.text();
            try {
                const json = JSON.parse(txt);
                log(json);
                return json;
            } catch {
                const info = { raw: txt, status: r.status };
                log(info);
                return info;
            }
        }

        // switching panel
        function togglePanel(which) {
            const panel = document.getElementById("panel-" + which);
            const btn = document.getElementById("btn" + which.charAt(0).toUpperCase() + which.slice(1));

            const willShow = panel.classList.contains("hidden");
            if (willShow) {
                panel.classList.remove("hidden");
                btn.classList.add("active");
                if (which === "workouts") {
                    loadWorkouts();
                } else if (which === "exercises") {
                    loadExercises();
                } else if (which === "sets") {
                    loadSets();
                }
            } else {
                panel.classList.add("hidden");
                btn.classList.remove("active");
            }
        }

        // WORKOUTS 
        const tbodyWorkouts = document.getElementById("tbodyWorkouts");
        const workoutSetsDetails = document.getElementById("workoutSetsDetails");

        async function loadWorkouts() {
            try {
                const workouts = await getJSON("/api/workouts");

                tbodyWorkouts.innerHTML = "";
                workouts.forEach(w => {
                    const tr = document.createElement("tr");

                    const tdId = document.createElement("td");
                    tdId.textContent = w.id;

                    const tdName = document.createElement("td");
                    tdName.textContent = w.name;

                    const tdDate = document.createElement("td");
                    tdDate.textContent = w.date;

                    const tdActions = document.createElement("td");

                    const btnDelete = document.createElement("button");
                    btnDelete.textContent = "Delete";
                    btnDelete.className = "action-btn action-delete";
                    btnDelete.style.marginLeft = "4px";
                    btnDelete.onclick = () => deleteWorkout(w.id);
                    tdActions.appendChild(btnDelete);

                    const btnView = document.createElement("button");
                    btnView.textContent = "View sets";
                    btnView.className = "action-btn action-view";
                    btnView.onclick = () => viewWorkoutSets(w);
                    tdActions.appendChild(btnView);

                    tr.appendChild(tdId);
                    tr.appendChild(tdName);
                    tr.appendChild(tdDate);
                    tr.appendChild(tdActions);

                    tbodyWorkouts.appendChild(tr);
                });
            } catch (e) {
                log("Failed to load workouts: " + e.message);
            }
        }

        async function addWorkout() {
            const name = prompt("Workout name:");
            const date = prompt("Date (YYYY-MM-DD):");
            if (!name || !date) {
                log("Name and Date required");
                return;
            }
            const resp = await postJSON("/api/workouts", { name, date });
            if (resp && resp.status === "ok") {
                await loadWorkouts();
            }
        }

        async function deleteWorkout(id) {
            if (!confirm("Delete this workout and all Sets in?")) { return; }
            const resp = await fetch(`/api/workouts?id=${id}`, {
                method: "DELETE"
            });
            const txt = await resp.text();
            let json;

            try {
                json = JSON.parse(txt);
            } catch {
                json = { raw: txt, status: resp.status };
            }

            log(json);

            if (resp.ok && json.status === "ok") {
                await loadWorkouts();
                await loadSets();
                workoutSetsDetails.innerHTML = "";
            }
        }

        async function viewWorkoutSets(workout) {
            try {
                const allSets = await getJSON("/api/sets");
                const filtered = allSets.filter(s => s.workout_id === workout.id);

                workoutSetsDetails.innerHTML = "";

                const h = document.createElement("h3");
                h.textContent = `Sets for workout: ${workout.name} (${workout.date})`;
                workoutSetsDetails.appendChild(h);

                if (filtered.length === 0) {
                    const p = document.createElement("p");
                    p.textContent = "No sets for this workout yet.";
                    workoutSetsDetails.appendChild(p);
                    return;
                }

                const list = document.createElement("ul");
                filtered.forEach(s => {
                    const li = document.createElement("li");
                    li.textContent = `${s.exercise_name}: ${s.repetitions} x ${s.aproaches}, ${s.weight} kg`;
                    list.appendChild(li);
                });
                workoutSetsDetails.appendChild(list);
            } catch (e) {
                log("Failed to load sets for workout: " + e.message);
            }
        }

        // EXERCISES
        const tbodyExercises = document.getElementById("tbodyExercises");

        async function loadExercises() {
            try {
                const exercises = await getJSON("/api/exercises");
                tbodyExercises.innerHTML = "";
                exercises.forEach(e => {
                    const tr = document.createElement("tr");

                    const tdId = document.createElement("td");
                    tdId.textContent = e.id;

                    const tdName = document.createElement("td");
                    tdName.textContent = e.name;

                    const tdActions = document.createElement("td");
                    const btnDel = document.createElement("button");
                    btnDel.textContent = "Delete";
                    btnDel.className = "action-btn action-delete";
                    btnDel.onclick = () => deleteExercise(e.id);
                    tdActions.appendChild(btnDel);

                    tr.appendChild(tdId);
                    tr.appendChild(tdName);
                    tr.appendChild(tdActions);

                    tbodyExercises.appendChild(tr);
                });
            } catch (e) {
                log("Failed to load exercises: " + e.message);
            }
        }

        async function addExercise() {
            const name = prompt("Exercise name:");
            if (!name) {
                log("Name is required");
                return;
            }
            const resp = await postJSON("/api/exercises", { name });
            if (resp && resp.status === "ok") {
                await loadExercises();
            }
        }

        async function deleteExercise(id) {
            if (!confirm("Delete this exercise and all related sets?")) {
                return;
            }

            const resp = await fetch(`/api/exercises?id=${id}`, {
                method: "DELETE"
            });

            const txt = await resp.text();
            let json;
            try {
                json = JSON.parse(txt);
            } catch {
                json = { raw: txt, status: resp.status };
            }
            log(json);

            if (resp.ok && json.status === "ok") {
                await loadExercises();
                await loadSets();
                workoutSetsDetails.innerHTML = "";
            }
        }

        // SETS
        const tbodySets = document.getElementById("tbodySets");
        const addSetBox = document.getElementById("addSetBox");
        const selWorkout = document.getElementById("selWorkout");
        const selExercise = document.getElementById("selExercise");

        async function loadSets() {
            try {
                const sets = await getJSON("/api/sets");
                tbodySets.innerHTML = "";
                sets.forEach(s => {
                    const tr = document.createElement("tr");

                    const tdId = document.createElement("td");
                    tdId.textContent = s.id;

                    const tdWorkout = document.createElement("td");
                    tdWorkout.textContent = s.workout_id;

                    const tdExercise = document.createElement("td");
                    tdExercise.textContent = s.exercise_name;

                    const tdRepApr = document.createElement("td");
                    tdRepApr.textContent = `${s.repetitions} × ${s.aproaches}`;

                    const tdWeight = document.createElement("td");
                    tdWeight.textContent = s.weight + " kg";

                    const tdActions = document.createElement("td");
                    const btnDel = document.createElement("button");
                    btnDel.textContent = "Delete";
                    btnDel.className = "action-btn action-delete";
                    btnDel.onclick = () => deleteSet(s.id);
                    tdActions.appendChild(btnDel);

                    tr.appendChild(tdId);
                    tr.appendChild(tdWorkout);
                    tr.appendChild(tdExercise);
                    tr.appendChild(tdRepApr);
                    tr.appendChild(tdWeight);
                    tr.appendChild(tdActions);

                    tbodySets.appendChild(tr);
                });
            } catch (e) {
                log("Failed to load sets: " + e.message);
            }
        }

        async function openAddSet() {
            try {
                const [workouts, exercises] = await Promise.all([
                    getJSON("/api/workouts"),
                    getJSON("/api/exercises")
                ]);

                selWorkout.innerHTML = "";
                workouts.forEach(w => {
                    const opt = document.createElement("option");
                    opt.value = w.id;
                    opt.textContent = `${w.name} (${w.date})`;
                    selWorkout.appendChild(opt);
                });

                selExercise.innerHTML = "";
                exercises.forEach(e => {
                    const opt = document.createElement("option");
                    opt.value = e.id;
                    opt.textContent = e.name;
                    selExercise.appendChild(opt);
                });

                addSetBox.classList.remove("hidden");
                log("Fill the fields and press 'Submit Set'");
            } catch (e) {
                log("Failed to load lists: " + e.message);
            }
        }

        function closeAddSet() {
            addSetBox.classList.add("hidden");
        }
        async function deleteSet(id) {
            if (!confirm("Delete this set?")) {
                return;
            }

            const resp = await fetch(`/api/sets?id=${id}`, {
                method: "DELETE"
            });

            const txt = await resp.text();
            let json;
            try {
                json = JSON.parse(txt);
            } catch {
                json = { raw: txt, status: resp.status };
            }
            log(json);

            if (resp.ok && json.status === "ok") {
                await loadSets();
                workoutSetsDetails.innerHTML = "";
            }
        }

        async function submitSet() {
            const workout_id = parseInt(selWorkout.value, 10);
            const exercise_id = parseInt(selExercise.value, 10);
            const weight = parseFloat(document.getElementById("sWeight").value);
            const repetitions = parseInt(document.getElementById("sReps").value, 10);
            const aproaches = parseInt(document.getElementById("sAproaches").value, 10);

            if (!Number.isFinite(workout_id) || !Number.isFinite(exercise_id)) {
                log("Pick workout and exercise");
                return;
            }
            if (!Number.isFinite(weight) || !Number.isFinite(repetitions) || !Number.isFinite(aproaches)) {
                log("Enter valid numbers for weight/repetitions/aproaches");
                return;
            }

            const resp = await postJSON("/api/sets", {
                workout_id, exercise_id, weight, repetitions, aproaches
            });
            if (resp && resp.status === "ok") {
                await loadSets();
                closeAddSet();
            }
        }
    </script>
</body>
</html>
